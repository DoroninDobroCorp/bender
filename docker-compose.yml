# Docker Compose for Parser Maker
# Development and production configurations

services:
  # Main application
  parser-maker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: parser-maker
    volumes:
      - ./:/app
      - parser-data:/app/data
      - parser-logs:/app/logs
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY:-}
      - DISPLAY_MODE=${DISPLAY_MODE:-visible}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - parser-network
    restart: unless-stopped

  # Development service with hot reload
  parser-maker-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: parser-maker-dev
    volumes:
      - ./:/app
      - parser-data:/app/data
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY:-}
      - PYTHONDONTWRITEBYTECODE=1
    command: ["python", "-m", "pytest", "tests/", "-v", "--tb=short"]
    networks:
      - parser-network
    profiles:
      - dev

  # Test runner
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: parser-maker-test
    volumes:
      - ./:/app
    command: ["python", "-m", "pytest", "tests/", "-v", "--cov=.", "--cov-report=term-missing"]
    networks:
      - parser-network
    profiles:
      - test

volumes:
  parser-data:
    driver: local
  parser-logs:
    driver: local

networks:
  parser-network:
    driver: bridge
